services:
  api:
    build:
      context: .
      dockerfile: api/Dockerfile
    env_file:
      - .env   
    environment:
      NODE_ENV: production
      OPENAI_API_KEY: ${OPENAI_API_KEY}  
      SUPABASE_URL: ${SUPABASE_URL}
      SUPABASE_SECRET_KEY: ${SUPABASE_SECRET_KEY}
    ports:
      - '8080:8080'
    healthcheck:
      test: ["CMD", "wget", "-qO-", "http://localhost:8080/api/health"]
      interval: 10s
      timeout: 3s
      retries: 5

  web:
    build:
      context: .
      dockerfile: web/Dockerfile
      args:
        VITE_API_URL: "/api"
        VITE_SUPABASE_URL: ${VITE_SUPABASE_URL}
        VITE_SUPABASE_ANON_KEY: ${VITE_SUPABASE_ANON_KEY}
    depends_on:
      api:
        condition: service_healthy  
    ports:
      - '5173:80'  
    env_file:
      - .env
    environment:
      VITE_SUPABASE_URL: ${VITE_SUPABASE_URL}
      VITE_SUPABASE_ANON_KEY: ${VITE_SUPABASE_ANON_KEY}
      VITE_API_URL: ${VITE_API_URL}
